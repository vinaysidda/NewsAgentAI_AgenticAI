<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>News Dashboard</title>
  <style>
    :root {
      --bg: #0b0c10;
      --card: #16181d;
      --text: #e6edf3;
      --muted: #9aa4af;
      --accent: #3b82f6;
      --border: #23262d;
      --danger: #ef4444;
      --success: #22c55e;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
      background: var(--bg);
      color: var(--text);
      line-height: 1.45;
    }
    header {
      padding: 20px 24px;
      border-bottom: 1px solid var(--border);
      position: sticky; top: 0; backdrop-filter: blur(6px);
      background: color-mix(in srgb, var(--bg) 85%, transparent);
    }
    h1 { margin: 0; font-size: 22px; letter-spacing: .2px; }

    main { padding: 20px 24px 80px; max-width: 1100px; margin: 0 auto; }

    .row { display: grid; gap: 10px; align-items: center; }
    .row.cols-4 { grid-template-columns: repeat(4, minmax(0, 1fr)); }
    .row.cols-6 { grid-template-columns: repeat(6, minmax(0, 1fr)); }
    .controls {
      display: grid; gap: 10px; margin-top: 14px;
      grid-template-columns: 1fr auto auto;
      align-items: end;
    }

    label { font-size: 12px; color: var(--muted); display: block; margin-bottom: 6px; }
    input, select, button, textarea {
      width: 100%;
      padding: 10px 12px;
      border-radius: 10px;
      border: 1px solid var(--border);
      background: var(--card);
      color: var(--text);
      outline: none;
    }
    textarea { min-height: 90px; resize: vertical; }
    input::placeholder, textarea::placeholder { color: #6b7280; }

    button { cursor: pointer; border: 1px solid var(--border); }
    .btn {
      background: linear-gradient(180deg, #1f2937, #111827);
      border: 1px solid #2b313b;
      box-shadow: 0 1px 0 rgba(255,255,255,0.03) inset;
      transition: transform .04s ease, filter .2s ease;
      font-weight: 600;
    }
    .btn:hover { filter: brightness(1.05); }
    .btn:active { transform: translateY(1px); }
    .btn-accent { background: linear-gradient(180deg, #2563eb, #1d4ed8); border-color: #1e40af; }
    .btn-danger { background: linear-gradient(180deg, #ef4444, #b91c1c); border-color: #7f1d1d; }

    .card { background: var(--card); border: 1px solid var(--border); border-radius: 14px; padding: 14px; }
    .muted { color: var(--muted); font-size: 12px; }
    .spacer { height: 6px; }

    table { width: 100%; border-collapse: collapse; }
    th, td { border-bottom: 1px solid var(--border); padding: 12px 10px; vertical-align: top; }
    th { text-align: left; font-size: 12px; color: var(--muted); font-weight: 600; }
    tr:hover td { background: #14171d; }
    pre { white-space: pre-wrap; margin: 8px 0 0; color: #cbd5e1; }
    a { color: #93c5fd; text-decoration: none; }
    a:hover { text-decoration: underline; }

    .status { margin-left: 8px; font-size: 12px; }
    .status.ok { color: var(--success); }
    .status.err { color: var(--danger); }

    .actions { display: flex; gap: 6px; }
  </style>
</head>
<body>
  <header>
    <h1>News Dashboard</h1>
  </header>

  <main>
    <section class="card">
      <div class="row cols-4">
        <div>
          <label for="source">Source</label>
          <select id="source">
            <option value="">All</option>
            <option value="BBC">BBC</option>
            <option value="CNN">CNN</option>
            <option value="FOX">FOX</option>
          </select>
        </div>
        <div>
          <label for="limit">Limit</label>
          <input id="limit" type="number" value="10" min="1" max="50" />
        </div>
        <div style="align-self:end">
          <button id="crawlBtn" class="btn btn-accent" onclick="crawl()">Crawl</button>
        </div>
        <div style="align-self:end"><span id="crawlStatus" class="status"></span></div>
      </div>
    </section>

    <div class="spacer"></div>

    <section class="card">
      <div class="row cols-4" style="align-items:end">
        <div>
          <label for="recipFile">Upload recipients CSV</label>
          <input id="recipFile" name="file" type="file" accept=".csv" />
          <div class="muted">Expected headers: <code>name,email</code></div>
        </div>
        <div>
          <button id="uploadBtn" class="btn" onclick="uploadRecipients()">Upload</button>
          <span id="uploadStatus" class="status"></span>
        </div>
      </div>
    </section>

    <div class="spacer"></div>

    <section class="card">
      <h3 style="margin:6px 0 12px">Email / Schedule</h3>
      <div class="row cols-6">
        <div>
          <label>SMTP Host</label>
          <input name="smtp_host" id="smtp_host" placeholder="smtp.gmail.com" />
        </div>
        <div>
          <label>Port</label>
          <input name="smtp_port" id="smtp_port" placeholder="465" value="465" />
        </div>
        <div>
          <label>Sender Email</label>
          <input name="sender" id="sender" placeholder="you@gmail.com" />
        </div>
        <div>
          <label>SMTP Username</label>
          <input name="username" id="username" placeholder="you@gmail.com" />
        </div>
        <div>
          <label>SMTP Password (App Password)</label>
          <input name="password" id="password" type="password" placeholder="16-char app password" />
        </div>
        <div>
          <label>Cron (optional)</label>
          <input id="cron" placeholder="*/30 * * * * (every 30 min)" />
        </div>
      </div>
      <div class="row" style="margin-top:10px; grid-template-columns: 1fr;">
        <div>
          <label>Subject</label>
          <input id="subject" placeholder="Daily News Digest" />
        </div>
        <div>
          <label>Body template</label>
          <textarea id="body" placeholder="Use {headlines}">Top headlines:\n{headlines}</textarea>
        </div>
        <div style="display:flex; gap:10px; align-items:center;">
          <button id="sendBtn" class="btn btn-accent" onclick="scheduleEmail()">Send / Schedule</button>
          <span id="emailStatus" class="status"></span>
        </div>
      </div>
    </section>

    <div class="spacer"></div>

    <section class="card">
      <table id="newsTable">
        <thead>
          <tr>
            <th style="width:70px">#</th>
            <th style="width:140px">Source</th>
            <th>Information (first ~80 lines)</th>
            <th style="width:160px">Actions</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </section>
  </main>

<script>
const qs = sel => document.querySelector(sel);
const setStatus = (el, text, ok=true) => { el.textContent = text; el.className = 'status ' + (ok ? 'ok' : 'err'); };

async function crawl() {
  const btn = qs('#crawlBtn');
  const statusEl = qs('#crawlStatus');
  btn.disabled = true; setStatus(statusEl, 'Crawlingâ€¦', true);
  try {
    const source = qs('#source').value;
    const limit = parseInt(qs('#limit').value || '10', 10);
    const params = new URLSearchParams({ limit });
    if (source) params.append('source', source);
    const res = await fetch('/crawl', { method: 'POST', body: params });
    if (!res.ok) throw new Error('HTTP ' + res.status);
    setStatus(statusEl, 'Crawl done', true);
    await refresh();
  } catch (err) {
    console.error(err);
    setStatus(statusEl, 'Crawl failed', false);
  } finally { btn.disabled = false; }
}

async function refresh() {
  const res = await fetch('/articles');
  const data = await res.json();
  const tbody = qs('#newsTable tbody');
  tbody.innerHTML = '';

  data.forEach((row, idx) => {
    const tr = document.createElement('tr');
    const snippet = (row.content || '').split('\n').slice(0, 80).join('\n');
    tr.innerHTML = `
      <td>${idx + 1}</td>
      <td>${row.source}</td>
      <td>
        <div><strong>${escapeHtml(row.title || '')}</strong></div>
        <div class="muted"><a href="${row.url}" target="_blank" rel="noopener">${row.url}</a></div>
        <pre>${escapeHtml(snippet)}</pre>
      </td>
      <td>
        <div class="actions">
          <button class="btn" onclick="editArticle(${row.id})">Edit</button>
          <button class="btn btn-danger" onclick="deleteArticle(${row.id})">Delete</button>
        </div>
      </td>
    `;
    tbody.appendChild(tr);
  });
}

function escapeHtml(s) {
  return String(s)
    .replaceAll('&', '&amp;')
    .replaceAll('<', '&lt;')
    .replaceAll('>', '&gt;');
}

async function editArticle(id) {
  const title = prompt('New title (leave blank to keep):');
  const content = prompt('New content (leave blank to keep):');
  const payload = {};
  if (title) payload.title = title;
  if (content) payload.content = content;
  await fetch(`/articles/${id}`, { method: 'PUT', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
  await refresh();
}

async function deleteArticle(id) {
  await fetch(`/articles/${id}`, { method: 'DELETE' });
  await refresh();
}

async function uploadRecipients() {
  const input = qs('#recipFile');
  const statusEl = qs('#uploadStatus');
  if (!input.files || !input.files[0]) { setStatus(statusEl, 'Pick a CSV first', false); return; }
  const fd = new FormData();
  fd.append('file', input.files[0]);
  try {
    const r = await fetch('/upload-recipients', { method: 'POST', body: fd });
    const j = await r.json();
    if (!r.ok) throw new Error(j?.detail || ('HTTP ' + r.status));
    setStatus(statusEl, `Loaded ${j.loaded} recipients`, true);
  } catch (e) {
    console.error(e);
    setStatus(statusEl, 'Upload failed', false);
  }
}

async function scheduleEmail() {
  const statusEl = qs('#emailStatus');
  const fd = new FormData();
  fd.append('smtp_host', qs('#smtp_host').value || 'smtp.gmail.com');
  fd.append('smtp_port', qs('#smtp_port').value || '465');
  fd.append('sender', qs('#sender').value);
  fd.append('username', qs('#username').value);
  fd.append('password', qs('#password').value);

  const subject = qs('#subject').value || 'News Digest';
  const body = qs('#body').value || 'Top:\n{headlines}';
  const cron = qs('#cron').value || '';
  fd.append('subject', subject);
  fd.append('body_template', body);
  if (cron) fd.append('cron', cron);

  try {
    const r = await fetch('/schedule-email', { method: 'POST', body: fd });
    const j = await r.json();
    if (!r.ok) throw new Error(j?.detail || ('HTTP ' + r.status));
    setStatus(statusEl, j.status === 'scheduled' ? 'Scheduled' : 'Sent', true);
  } catch (e) {
    console.error(e);
    setStatus(statusEl, 'Send failed', false);
  }
}

refresh();
</script>
</body>
</html>

